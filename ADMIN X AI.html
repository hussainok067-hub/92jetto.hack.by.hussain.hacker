<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• DRK ADMIN PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Basic Reset and Variables (Red/Black Theme) */
        :root {
            --bg-color: #0d0d0d; /* Deep Black */
            --card-bg: #1a1a1a; /* Darker Gray */
            --text-color: #f0f0f0;
            --primary-color: #ff3333; /* Bright Red (Action Color) */
            --secondary-color: #ff9933; /* Orange/Accent */
            --input-bg: #2c2c2c;
            --border-color: #3e3e3e;
            --shadow: 0 6px 15px rgba(255, 51, 51, 0.1);
            --sidebar-width: 250px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Sidebar Menu Styles --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #111;
            padding: 20px 0;
            position: fixed;
            top: 0;
            left: 0; 
            height: 100%;
            transition: left 0.3s;
            z-index: 1001;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
        }
        .sidebar-header {
            color: var(--primary-color);
            text-align: center;
            padding: 10px 20px 30px;
            font-size: 1.4rem;
            font-weight: 900;
        }
        .sidebar a {
            padding: 15px 20px;
            text-decoration: none;
            font-size: 1rem;
            color: var(--text-color);
            display: block;
            transition: background-color 0.2s, color 0.2s;
            border-left: 5px solid transparent;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #242424;
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }
        .sidebar a i {
            margin-right: 10px;
        }
        /* Mobile menu hide/show */
        @media (max-width: 768px) {
            .sidebar { left: -250px; }
            .sidebar.active { left: 0; }
        }

        /* --- Main Content and Header --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            width: 100%;
            margin-left: var(--sidebar-width); /* Default desktop margin */
        }
         @media (max-width: 768px) {
            .main-content { margin-left: 0; padding-top: 60px; }
            header { position: fixed; top: 0; left: 0; right: 0; background: #111; z-index: 999; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        }

        header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 30px;
        }
        .menu-toggle {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--primary-color);
            padding: 5px;
            margin-right: 20px;
            display: none;
        }
         @media (max-width: 768px) {
            .menu-toggle { display: block; }
        }
        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 0 0 8px rgba(255, 51, 51, 0.5);
        }

        /* --- Section Content Styles --- */
        .section-content { display: none; }
        .section-content.active { display: block; }
        
        .card {
            background-color: var(--card-bg);
            padding: 25px; 
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        .card h3 {
            color: var(--primary-color);
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .card h4 {
             color: var(--secondary-color);
             margin-top: 20px;
             margin-bottom: 15px;
        }


        /* --- Form Elements & Buttons (General) --- */
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 700; font-size: 0.9em; color: var(--secondary-color); }
        input[type="text"], input[type="number"], input[type="date"] {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;
            background-color: var(--input-bg); color: var(--text-color); font-size: 1em;
            transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 5px rgba(255, 51, 51, 0.5); }

        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: 700; transition: background-color 0.3s, transform 0.1s; margin-top: 10px; }
        .btn-primary { background-color: var(--primary-color); color: var(--bg-color); width: 100%; }
        .btn-primary:hover { background-color: #e60000; transform: translateY(-1px); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--bg-color); padding: 8px 15px; }
        
        .card .status-text { margin-top: 10px; color: var(--secondary-color); font-weight: bold; font-size: 0.9em; }
        
        /* --- Inline Form Fix (Expiry) --- */
        .form-group-inline {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 equal columns for D/H/M/S */
            gap: 10px;
            margin-bottom: 15px;
        }
        .form-group-item {
            display: flex;
            flex-direction: column;
        }
        .form-group-item input {
            text-align: center;
            padding: 8px 5px;
            width: 100%; /* Ensure inputs take full width of their small column */
        }
        @media (max-width: 450px) {
             .form-group-inline {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on very small screens */
            }
        }


        /* --- History Table Styles --- */
        .history-content-wrap {
            max-height: 250px; 
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 15px;
        }
        .history-content-wrap::-webkit-scrollbar { width: 8px; }
        .history-content-wrap::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; }
        .history-content-wrap::-webkit-scrollbar-track { background: var(--input-bg); }

        .pred-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            font-weight: 400;
            text-align: center;
            background: var(--input-bg);
        }
        .pred-history-table th {
            background: #3e3e3e; 
            color: var(--text-color);
            padding: 10px 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        .pred-history-table td {
            padding: 10px 5px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            word-break: break-all;
        }
        .pred-history-table tr:nth-child(even) {
            background: #111111; 
        }

        /* --- Active Display --- */
        #activeExpiryDisplay {
            padding: 15px;
            background: var(--input-bg);
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebar-admin-name">DRK Admin</div>
    <a href="#" class="nav-link active" data-target="link-name-management"><i class="fas fa-link"></i> Link & Name Mgt</a>
    <a href="#" class="nav-link" data-target="logic-management"><i class="fas fa-cogs"></i> Logic Management</a>
    <a href="#" class="nav-link" data-target="expire-management"><i class="fas fa-calendar-times"></i> Expiry Management</a>
    <a href="#" class="nav-link" data-target="device-management"><i class="fas fa-mobile-alt"></i> Device Management</a>
</div>

<div class="main-content" id="main-content">
    <header>
        <div class="menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </div>
        <h1 id="main-header-title">Admin Panel</h1>
    </header>

    <div id="link-name-management" class="section-content active">
        <div class="card">
            <h3>üîó Settings (Link & Name)</h3>
            <p style="font-size: 0.9em; color: #aaa;">Fill the fields you want to update. Empty fields will remain unchanged.</p>
            
            <div class="form-group">
                <label for="telegramLink">Telegram Link (Button URL):</label>
                <input type="text" id="telegramLink" placeholder="https://t.me/+..." value="">
            </div>
            
            <div class="form-group">
                <label for="gameIframeSrc">Game iFrame URL (Main Link):</label>
                <input type="text" id="gameIframeSrc" placeholder="https://www.jalwagameapp5.com/#/register?invitationCode=..." value="">
            </div>
            
            <div class="form-group" style="margin-top: 25px;">
                <label for="hackName">User Page Main Hack Name (Browser Tab Title & Main Heading)</label>
                <input type="text" id="hackName" placeholder="VIP JALWA HACK DRK" value="">
            </div>
            
            <div class="form-group">
                <label for="adminName">Admin Display Name (Sidebar Header):</label>
                <input type="text" id="adminName" placeholder="Admin Name" value="">
            </div>
            
            <button class="btn btn-primary" onclick="updateSettings()">UPDATE SETTINGS</button>
            <div id="settings-status" class="status-text"></div>
        </div>
        
    </div>

    <div id="logic-management" class="section-content">
        <div class="card">
            <h3 style="display: flex; justify-content: space-between; align-items: center; color: var(--text-color);">
                <span id="currentTimeDisplay">--:--:--</span>
                <span style="font-size: 1.2rem; color: var(--primary-color);">|</span>
                <span id="currentPeriodDisplay" style="color: var(--secondary-color); font-weight: 900;">Current Period: Loading...</span>
            </h3>
            
            <h4 style="color: var(--secondary-color); margin-top: 15px; margin-bottom: 5px;">Periodic Logic Setter</h4>
            
            <div class="override-control-panel">
                <div class="override-inputs-flex">
                    <div class="form-group">
                        <label for="overrideLastDigit">Period End Digit (0-9)</label>
                        <input type="number" id="overrideLastDigit" placeholder="e.g.: 7" min="0" max="9" step="1">
                    </div>
                    <div class="form-group">
                        <label for="overrideNumber">Number Box (e.g. 7/1/9)</label>
                        <input type="text" id="overrideNumber" placeholder="e.g.: 7/1/9">
                    </div>
                    <div class="form-group">
                        <label for="overrideSize">BIGG / SMALL Box</label>
                        <input type="text" id="overrideSize" placeholder="BIGG or SMALL">
                    </div>
                </div>
                <button class="btn btn-primary" id="confirmPeriodicLogicBtn" onclick="confirmPeriodicLogic()">CONFIRM PERIODIC LOGIC</button>
            </div>
            <div id="override-status" class="status-text" style="padding-left: 0;">Enter Period End Digit (0-9) to check/set logic.</div>

            <div class="history-section-admin">
                <h4 style="color: var(--primary-color); margin-top: 20px;">Logic History (Last 10)</h4>
                <div class="history-content-wrap">
                    <table class="pred-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>End Digit</th>
                                <th>Number</th>
                                <th>Size</th>
                            </tr>
                        </thead>
                        <tbody id="logicHistoryTableBody">
                            <tr><td colspan="4">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="expire-management" class="section-content">
        <div class="card">
            <h3>‚è≥ Set New Expiry</h3>
            <p style="font-size: 0.9em; color: #aaa;">Set the expiration period from the current time.</p>
            
            <div class="form-group-inline">
                <div class="form-group-item">
                    <label for="expireDays">Days</label>
                    <input type="number" id="expireDays" min="0" value="0">
                </div>
                <div class="form-group-item">
                    <label for="expireHours">Hours</label>
                    <input type="number" id="expireHours" min="0" max="999" value="0">
                </div>
                <div class="form-group-item">
                    <label for="expireMinutes">Minutes</label>
                    <input type="number" id="expireMinutes" min="0" max="59" value="0">
                </div>
                <div class="form-group-item">
                    <label for="expireSeconds">Seconds</label>
                    <input type="number" id="expireSeconds" min="0" max="59" value="0">
                </div>
            </div>

             <div class="form-group">
                <label for="expireMessage">Expiry Message (Visible to User):</label>
                <input type="text" id="expireMessage" placeholder="Your subscription has expired. Contact admin.">
            </div>
            <button class="btn btn-primary" onclick="setRelativeExpire()">SET EXPIRY</button>
            <div id="expire-status" class="status-text"></div>

            <h4 style="color: var(--primary-color); margin-top: 20px;">Active Expiry Status</h4>
            <div id="activeExpiryDisplay">No active expiry set.</div>
        </div>

        <div class="card">
            <h4 style="color: var(--secondary-color); margin-top: 0;">Expired/Past Expiry History</h4>
            <div class="history-content-wrap">
                <table class="pred-history-table">
                    <thead>
                        <tr>
                            <th>Time Set</th>
                            <th>Expiry Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="expiredHistoryTableBody">
                        <tr><td colspan="3">No expired history.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="device-management" class="section-content">
        <div class="card">
            <h3>üì± Device Limit Management</h3>
            <p style="font-size: 0.9em; color: #aaa;">Set the maximum number of devices that can actively use the system concurrently.</p>
             <div class="form-group">
                <label for="maxDevices">Maximum Active Devices (Number):</label>
                <input type="number" id="maxDevices" min="1" value="1">
            </div>
            <button class="btn btn-primary" onclick="updateDeviceSettings()">UPDATE DEVICE LIMIT</button>
            <div id="device-limit-status" class="status-text"></div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h4>Active Devices / Sessions</h4>
            <p style="font-size: 0.9em; color: var(--secondary-color); font-weight: 700;">Total Active: <span id="activeDeviceCount">0</span> (Refreshes every 30s)</p>
            <div class="history-content-wrap">
                <table class="pred-history-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Device ID</th>
                            <th>Last Activity</th>
                            <th style="width: 20%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="activeDevicesTableBody">
                        <tr><td colspan="3">Loading active devices...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="device-list-status" class="status-text" style="margin-top: 10px;"></div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h4 style="color: var(--primary-color); margin-top: 0;">Blocked/Removed Devices History</h4>
            <p style="font-size: 0.9em; color: #aaa;">These devices have been manually blocked by the admin.</p>
            <div class="history-content-wrap">
                <table class="pred-history-table">
                    <thead>
                        <tr>
                            <th style="width: 65%;">Device ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="blockedDevicesTableBody">
                        <tr><td colspan="2">No blocked devices.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // =========================================================
    // ‚ö†Ô∏è IMPORTANT: Your Firebase Configuration
    // =========================================================
    const firebaseConfig = { 
      apiKey: "AIzaSyAK7VXejH4G51pbvtiocPFhsh66pSklTQs",
      authDomain: "drk-jalwa.firebaseapp.com",
      databaseURL: "https://drk-jalwa-default-rtdb.firebaseio.com",
      projectId: "drk-jalwa",
      storageBucket: "drk-jalwa.firebasestorage.app",
      messagingSenderId: "412915199281",
      appId: "1:412915199281:web:199208c82025d979665410",
      measurementId: "G-EPF2KV4BFY"
    };
    
    // Firebase Initialize
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // References
    const settingsRef = db.ref('settings');
    const managementRef = db.ref('management'); 
    const periodicLogicRef = db.ref('logic/periodic'); 
    const logicHistoryRef = db.ref('management/logicHistory'); 
    const devicesRef = db.ref('management/devices');
    const expireRef = db.ref('management/expire');
    const expiredHistoryRef = db.ref('management/expiryHistory'); 
    
    // Global elements
    const periodDisplay = document.getElementById('currentPeriodDisplay');
    const timeDisplay = document.getElementById('currentTimeDisplay');
    const overrideStatus = document.getElementById('override-status');
    const logicHistoryTableBody = document.getElementById('logicHistoryTableBody');
    const settingsStatus = document.getElementById('settings-status');
    const expireStatus = document.getElementById('expire-status');
    const deviceLimitStatus = document.getElementById('device-limit-status');
    const activeDevicesTableBody = document.getElementById('activeDevicesTableBody');
    const blockedDevicesTableBody = document.getElementById('blockedDevicesTableBody');
    const maxDevicesInput = document.getElementById('maxDevices');
    const activeDeviceCount = document.getElementById('activeDeviceCount');
    const expiredHistoryTableBody = document.getElementById('expiredHistoryTableBody');

    // External API Info
    const API_URL = 'https://api.bdg88zf.com/api/webapi/GetGameIssue';
    const API_PAYLOAD_STATIC = { 
        typeId: 1, language: 0,
        random: "40079dcba93a48769c6ee9d4d4fae23f", 
        signature: "D12108C4F57C549D82B23A91E0FA20AE"
    };

    // --- Utility Function to format timestamp ---
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-IN') + ' ' + date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    // --- Side Menu Logic ---
    function toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');

            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(nav => {
                nav.classList.remove('active');
            });

            document.getElementById(targetId).classList.add('active');
            this.classList.add('active');
            
            // Set main header title based on link text
            document.getElementById('main-header-title').textContent = this.textContent.trim();
            
            if(window.innerWidth <= 768) { toggleMenu(); }
        });
    });
    
    // Default Title on Load
    document.getElementById('main-header-title').textContent = document.querySelector('.nav-link.active').textContent.trim();


    // =========================================================
    // I. LINK & NAME MANAGEMENT LOGIC (Combined into one update function)
    // =========================================================

    // Load settings on startup
    settingsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // Inputs
            document.getElementById('telegramLink').value = data.telegramLink || '';
            document.getElementById('gameIframeSrc').value = data.gameIframeSrc || '';
            document.getElementById('adminName').value = data.adminName || '';
            document.getElementById('hackName').value = data.hackName || '';
            
            // Display updates
            document.getElementById('sidebar-admin-name').textContent = data.adminName || 'DRK Admin';

            settingsStatus.textContent = 'Settings loaded successfully.';
        }
    });

    function updateSettings() {
        const tLink = document.getElementById('telegramLink').value.trim();
        const iframeSrc = document.getElementById('gameIframeSrc').value.trim();
        const adminName = document.getElementById('adminName').value.trim();
        const hackName = document.getElementById('hackName').value.trim(); 
        
        const updates = {};
        if (tLink) updates.telegramLink = tLink;
        if (iframeSrc) updates.gameIframeSrc = iframeSrc;
        if (adminName) updates.adminName = adminName;
        if (hackName) updates.hackName = hackName; 
        
        if (Object.keys(updates).length === 0) {
            settingsStatus.textContent = '‚ùå Please fill at least one field to update.';
            setTimeout(() => settingsStatus.textContent = '', 3000);
            return;
        }

        settingsRef.update(updates).then(() => {
            settingsStatus.textContent = '‚úÖ Settings updated successfully!';
            setTimeout(() => settingsStatus.textContent = '', 3000);
        }).catch((error) => {
            console.error("Error updating settings: ", error);
            settingsStatus.textContent = '‚ùå Error updating settings!';
            setTimeout(() => settingsStatus.textContent = '', 3000);
        });
    }

    // =========================================================
    // II. PERIODIC LOGIC SETTER AND HISTORY LOGIC
    // =========================================================
    
    const overrideLastDigitInput = document.getElementById('overrideLastDigit');
    const overrideNumberInput = document.getElementById('overrideNumber');
    const overrideSizeInput = document.getElementById('overrideSize');

    overrideLastDigitInput.addEventListener('input', function() {
        const lastDigit = this.value.trim();
        
        if (lastDigit === '' || isNaN(lastDigit) || parseInt(lastDigit) < 0 || parseInt(lastDigit) > 9) {
            overrideNumberInput.value = '';
            overrideSizeInput.value = '';
            overrideStatus.textContent = 'Please enter a valid Period End Digit (0-9).';
            return;
        }

        periodicLogicRef.child(lastDigit).once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                overrideNumberInput.value = data.number || '';
                overrideSizeInput.value = data.size || '';
                overrideStatus.textContent = `Logic Loaded: ${data.number || '---'} | ${data.size || '---'}`;
            } else {
                overrideNumberInput.value = '';
                overrideSizeInput.value = '';
                overrideStatus.textContent = `No logic set. Ready to set new logic.`;
            }
        });
    });

    function confirmPeriodicLogic() {
        const lastDigit = overrideLastDigitInput.value.trim();
        const numbers = overrideNumberInput.value.trim();
        let size = overrideSizeInput.value.trim().toUpperCase();
        
        if (lastDigit === '' || isNaN(lastDigit) || parseInt(lastDigit) < 0 || parseInt(lastDigit) > 9) {
            overrideStatus.textContent = '‚ùå Please enter a valid Period End Digit (0-9).';
            setTimeout(() => overrideStatus.textContent = '', 5000);
            return;
        }
        if (!numbers || !size) {
            overrideStatus.textContent = '‚ùå Please fill both Number and BIGG/SMALL fields.';
            setTimeout(() => overrideStatus.textContent = '', 5000);
            return;
        }
        if (size !== 'BIGG' && size !== 'SMALL') {
            overrideStatus.textContent = "‚ùå Size must be 'BIGG' or 'SMALL'.";
            setTimeout(() => overrideStatus.textContent = '', 5000);
            return;
        }
        
        const color = (size === 'BIGG') ? '#ff8b6b' : '#4cc9ff'; // Note: Client side color logic is outside the scope of red/black admin UI
        
        periodicLogicRef.child(lastDigit).set({
            number: numbers,
            size: size,
            color: color,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP 
        }).then(() => {
            logicHistoryRef.push({
                lastDigit: lastDigit,
                number: numbers,
                size: size,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            overrideStatus.textContent = `‚úÖ Logic Saved: ${numbers} | ${size}!`;
            overrideNumberInput.value = '';
            overrideSizeInput.value = '';
            overrideLastDigitInput.value = '';

            setTimeout(() => overrideStatus.textContent = 'Enter Period End Digit (0-9) to check/set logic.', 5000);
        }).catch((error) => {
            overrideStatus.textContent = '‚ùå Error setting Periodic Logic!';
            setTimeout(() => overrideStatus.textContent = '', 5000);
        });
    }

    logicHistoryRef.limitToLast(10).on('value', (snapshot) => {
        const historyData = snapshot.val();
        const rows = [];
        logicHistoryTableBody.innerHTML = ''; 
        if (historyData) {
            const historyArray = Object.values(historyData).reverse();
            historyArray.forEach(item => {
                const row = `
                    <tr>
                        <td>${formatTimestamp(item.timestamp).split(' ')[1]}</td>
                        <td>${item.lastDigit}</td>
                        <td>${item.number}</td>
                        <td style="color: ${item.size === 'BIGG' ? '#ff3333' : '#ff9933'}; font-weight: 700;">${item.size}</td>
                    </tr>
                `;
                rows.push(row);
            });
            logicHistoryTableBody.innerHTML = rows.join('');
        } else {
             logicHistoryTableBody.innerHTML = '<tr><td colspan="4">No logic history available.</td></tr>';
        }
    });

    // =========================================================
    // III. EXPIRE MANAGEMENT LOGIC
    // =========================================================

    function setRelativeExpire() {
        const days = parseInt(document.getElementById('expireDays').value) || 0;
        const hours = parseInt(document.getElementById('expireHours').value) || 0;
        const minutes = parseInt(document.getElementById('expireMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('expireSeconds').value) || 0;
        const message = document.getElementById('expireMessage').value.trim() || 'Service has expired. Contact admin.';

        if (days + hours + minutes + seconds === 0) {
            expireStatus.textContent = '‚ùå Please enter some time to set the expiry.';
            setTimeout(() => expireStatus.textContent = '', 3000);
            return;
        }
        
        const now = Date.now();
        const expirationTimeMs = (days * 86400 + hours * 3600 + minutes * 60 + seconds) * 1000;
        const expiryTimestamp = now + expirationTimeMs;

        // If an expiry is currently active, move it to history before setting new one
        expireRef.once('value', (snapshot) => {
            const activeData = snapshot.val();
            if (activeData && activeData.timestamp > 0) {
                 expiredHistoryRef.push(activeData); // Move active expiry to history
            }
        });

        expireRef.set({
            timestamp: expiryTimestamp, 
            message: message,
            timeSet: now
        }).then(() => {
            expireStatus.textContent = '‚úÖ Expiry set successfully!';
            // Clear inputs
            document.getElementById('expireDays').value = 0;
            document.getElementById('expireHours').value = 0;
            document.getElementById('expireMinutes').value = 0;
            document.getElementById('expireSeconds').value = 0;
            setTimeout(() => expireStatus.textContent = '', 5000);
        }).catch((error) => {
            expireStatus.textContent = '‚ùå Error setting Expiry: ' + error.message;
            setTimeout(() => expireStatus.textContent = '', 5000);
        });
    }
    
    function updateActiveExpiryDisplay(timestamp, message, timeSet) {
        const displayElement = document.getElementById('activeExpiryDisplay');
        const futureTime = formatTimestamp(timestamp);
        
        const countdownId = 'expiryCountdown';
        displayElement.innerHTML = `
            <p style="margin: 5px 0; font-weight: 700; color: #ff9933;">Expiry Time: <span id="expiryFullTime">${futureTime}</span></p>
            <p style="margin: 5px 0; font-weight: 700;">Time Remaining: <span id="${countdownId}">Loading...</span></p>
            <p style="margin: 5px 0; font-size: 0.9em; color: #aaa;">Set On: ${formatTimestamp(timeSet)}</p>
            <p style="margin: 5px 0; font-size: 0.9em; color: var(--primary-color);">Message: ${message}</p>
            <button class="btn" onclick="clearExpiry()" style="background: #e60000; color: white; width: auto; padding: 5px 10px; margin-top: 10px;">CLEAR EXPIRY</button>
        `;

        if (window.activeExpiryInterval) {
            clearInterval(window.activeExpiryInterval);
        }
        
        window.activeExpiryInterval = setInterval(() => {
            const remainingTime = timestamp - Date.now();
            const countdownEl = document.getElementById(countdownId);
            
            if (remainingTime <= 0) {
                clearInterval(window.activeExpiryInterval);
                window.activeExpiryInterval = null;
                countdownEl.textContent = 'EXPIRED!';
                displayElement.innerHTML = 'Expired. Clear or set new expiry.';
                expireRef.once('value', s => { // Move to history on expiry
                    const expiredData = s.val();
                    if(expiredData) { expiredHistoryRef.push(expiredData); expireRef.remove(); }
                });
                return;
            }

            const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
            const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

            countdownEl.textContent = 
                `${days}d, ${hours.toString().padStart(2, '0')}h, ${minutes.toString().padStart(2, '0')}m, ${seconds.toString().padStart(2, '0')}s`;
        }, 1000);
    }

    function clearExpiry() {
        if (!confirm('Are you sure you want to clear the active expiry? The system will remain active until a new expiry is set.')) return;

        expireRef.once('value', (s) => {
            const data = s.val();
            if (data) {
                // Keep the record in history
                expiredHistoryRef.push(data).then(() => {
                    expireRef.remove().then(() => {
                        document.getElementById('activeExpiryDisplay').innerHTML = '‚úÖ Expiry cleared.';
                        if (window.activeExpiryInterval) clearInterval(window.activeExpiryInterval);
                        setTimeout(() => document.getElementById('activeExpiryDisplay').innerHTML = 'No active expiry set.', 3000);
                    });
                });
            } else {
                expireRef.remove().then(() => {
                    document.getElementById('activeExpiryDisplay').innerHTML = '‚úÖ Expiry cleared.';
                    if (window.activeExpiryInterval) clearInterval(window.activeExpiryInterval);
                    setTimeout(() => document.getElementById('activeExpiryDisplay').innerHTML = 'No active expiry set.', 3000);
                });
            }
        });
    }

    // Restore an item from expiry history
    function restoreExpiry(key, data) {
        if (!confirm('Are you sure you want to restore this expiry? The current active expiry (if any) will be overridden.')) return;
        
        // 1. Set the restored item as the new active expiry
        expireRef.set(data).then(() => {
            // 2. Remove the restored item from history
            expiredHistoryRef.child(key).remove().then(() => {
                expireStatus.textContent = '‚úÖ Expiry Restored Successfully!';
                setTimeout(() => expireStatus.textContent = '', 5000);
            });
        }).catch(e => {
            expireStatus.textContent = '‚ùå Error Restoring Expiry!';
            console.error(e);
        });
    }


    // Listen for live changes to Expiry settings
    expireRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.timestamp && data.timestamp > Date.now()) {
            updateActiveExpiryDisplay(data.timestamp, data.message, data.timeSet);
        } else {
            document.getElementById('activeExpiryDisplay').innerHTML = 'No active expiry set.';
            if (window.activeExpiryInterval) clearInterval(window.activeExpiryInterval);
        }
    });

    // Listen for Expired History
    expiredHistoryRef.on('value', (snapshot) => {
        const data = snapshot.val();
        const rows = [];
        expiredHistoryTableBody.innerHTML = '';
        if (data) {
            const historyArray = Object.entries(data).reverse();
            historyArray.forEach(([key, item]) => {
                const row = `
                    <tr>
                        <td>${formatTimestamp(item.timeSet)}</td>
                        <td>${formatTimestamp(item.timestamp)}</td>
                        <td>
                            <button class="btn-secondary" style="background: var(--primary-color); padding: 5px 10px;" onclick="restoreExpiry('${key}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">RESTORE</button>
                        </td>
                    </tr>
                `;
                rows.push(row);
            });
            expiredHistoryTableBody.innerHTML = rows.join('');
        } else {
            expiredHistoryTableBody.innerHTML = '<tr><td colspan="3">No expired history.</td></tr>';
        }
    });


    // =========================================================
    // IV. DEVICE MANAGEMENT LOGIC
    // =========================================================

    // Update Max Devices Limit
    function updateDeviceSettings() {
        const max = parseInt(document.getElementById('maxDevices').value);
        
        if (isNaN(max) || max < 1) {
            deviceLimitStatus.textContent = '‚ùå Please enter a valid number (1 or more) for max devices.';
            setTimeout(() => deviceLimitStatus.textContent = '', 5000);
            return;
        }

        devicesRef.update({
            maxAllowed: max
        }).then(() => {
            deviceLimitStatus.textContent = '‚úÖ Device Limit updated successfully!';
            setTimeout(() => deviceLimitStatus.textContent = '', 5000);
        });
    }

    // Load current Max Limit on startup
    devicesRef.child('maxAllowed').on('value', (snapshot) => {
        const max = snapshot.val();
        if (max !== null) {
            maxDevicesInput.value = max;
        }
    });

    // Function to block a device (add to 'removed' list)
    function removeDevice(deviceId) {
        if (!confirm(`Are you sure you want to block Device ID ${deviceId}? It will be blocked permanently until unblocked.`)) return;

        devicesRef.child('active').child(deviceId).remove().then(() => {
            devicesRef.child('removed').child(deviceId).set(true);
            // List will refresh automatically due to listener
        }).catch(error => {
            console.error('Error removing device:', error);
            deviceListStatus.textContent = `‚ùå Error removing device: ${error.message}`;
            setTimeout(() => deviceListStatus.textContent = '', 3000);
        });
    }

    // Function to unblock/restore a device (remove from 'removed' list)
    function restoreDevice(deviceId) {
        if (!confirm(`Are you sure you want to unblock Device ID ${deviceId}? It will be able to access the system again.`)) return;
        
        devicesRef.child('removed').child(deviceId).remove().then(() => {
            // The user will need to log in again on the client side to be registered as active
            deviceLimitStatus.textContent = `‚úÖ Device ID ${deviceId} unblocked successfully.`;
            setTimeout(() => deviceLimitStatus.textContent = '', 5000);
        }).catch(error => {
            console.error('Error restoring device:', error);
            deviceLimitStatus.textContent = `‚ùå Error restoring device: ${error.message}`;
            setTimeout(() => deviceLimitStatus.textContent = '', 5000);
        });
    }


    // Load and Display Active Devices (List/History) & Blocked Devices
    devicesRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const activeDevices = data.active || {};
        const removedDevices = data.removed || {};
        
        const activeRows = [];
        const blockedRows = [];
        activeDevicesTableBody.innerHTML = '';
        blockedDevicesTableBody.innerHTML = '';
        const now = Date.now();
        
        // --- Process Active Devices ---
        if (activeDevices) {
            const deviceArray = Object.entries(activeDevices).map(([id, d]) => ({ id, ...d }));
            const validActiveDevices = deviceArray.filter(item => {
                // Filter out devices inactive for more than 5 minutes (300000ms) AND not explicitly removed
                return item.lastActive && (now - item.lastActive) < 300000 && !removedDevices[item.id];
            });
            validActiveDevices.sort((a, b) => b.lastActive - a.lastActive); 
            
            validActiveDevices.forEach(item => {
                const timeString = formatTimestamp(item.lastActive).split(' ')[1];
                const userAgentSnippet = item.userAgent ? item.userAgent.substring(0, 30) + '...' : 'N/A';
                
                const row = `
                    <tr>
                        <td style="font-size: 10px;" title="${item.userAgent || 'N/A'}">${item.id}<br><span style="font-size: 8px; color:#aaa;">(${userAgentSnippet})</span></td>
                        <td>${timeString}</td>
                        <td>
                            <button class="btn-secondary" style="background: var(--primary-color); padding: 5px 10px;" onclick="removeDevice('${item.id}')">BLOCK</button>
                        </td>
                    </tr>
                `;
                activeRows.push(row);
            });
            activeDevicesTableBody.innerHTML = activeRows.join('');
            activeDeviceCount.textContent = validActiveDevices.length;
        } else {
            activeDevicesTableBody.innerHTML = '<tr><td colspan="3">No active devices.</td></tr>';
            activeDeviceCount.textContent = '0';
        }

        // --- Process Blocked Devices ---
        if (removedDevices && Object.keys(removedDevices).length > 0) {
            Object.keys(removedDevices).forEach(id => {
                const row = `
                    <tr>
                        <td style="font-size: 10px;">${id}</td>
                        <td>
                            <button class="btn-secondary" style="background: #00bfff; padding: 5px 10px;" onclick="restoreDevice('${id}')">UNBLOCK</button>
                        </td>
                    </tr>
                `;
                blockedRows.push(row);
            });
            blockedDevicesTableBody.innerHTML = blockedRows.join('');
        } else {
            blockedDevicesTableBody.innerHTML = '<tr><td colspan="2">No blocked devices.</td></tr>';
        }
    });
    
    // =========================================================
    // V. REAL-TIME CLOCK AND API LOGIC
    // =========================================================

    function updateRealTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
    }

    async function fetchCurrentPeriod(){
        try {
            const currentTimestamp = Math.floor(Date.now() / 1000);
            const dynamicPayload = { ...API_PAYLOAD_STATIC, timestamp: currentTimestamp };

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(dynamicPayload)
            });
            
            const j = await res.json();
            
            if(j && j.code===0 && j.data && j.data.issueNumber){
                const currentPeriod = j.data.issueNumber.toString();
                const last3 = currentPeriod.slice(-3);
                
                periodDisplay.textContent = 'Current Period: ' + last3;
            } else {
                periodDisplay.textContent = `Current Period: API Error`;
            }
        } catch (e) {
            periodDisplay.textContent = 'Current Period: Network Error';
        }
    }
    
    // Export functions to global scope (for onclick)
    window.toggleMenu = toggleMenu;
    window.updateSettings = updateSettings; // Renamed
    window.confirmPeriodicLogic = confirmPeriodicLogic; 
    window.setRelativeExpire = setRelativeExpire; 
    window.clearExpiry = clearExpiry; 
    window.restoreExpiry = restoreExpiry;
    window.updateDeviceSettings = updateDeviceSettings;
    window.removeDevice = removeDevice; 
    window.restoreDevice = restoreDevice; 
    
    // Initial calls
    updateRealTime();
    setInterval(updateRealTime, 1000); 
    
    fetchCurrentPeriod();
    setInterval(fetchCurrentPeriod, 5000);
</script>
</body>
</html>